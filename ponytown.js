// ==UserScript==
// @name         Pony Town ÂäüËÉΩÊèí‰ª∂
// @namespace    http://tampermonkey.net/
// @version      0.2
// @description  Â∞ÜÊ®°ÂûãÂ∞ÅË£Ö„ÄÅ‰ºòÂåñUIÁïåÈù¢
// @author       YourName
// @match        https://pony.town/*
// @grant        GM_xmlhttpRequest
// @grant        GM_setValue
// @grant        GM_getValue
// @connect      api.deepseek.com
// @connect      dashscope.aliyuncs.com
// ==/UserScript==

(function() {
    'use strict';

    // ÂÆö‰πâÊ®°ÂûãÈÖçÁΩÆ
    const MODEL_CONFIGS = [
        {
            id: 'deepseek-chat',
            name: 'DeepSeek Chat',
            url: 'https://api.deepseek.com/chat/completions',
            apiKey: '' // ÊõøÊç¢‰∏∫ÊÇ®ÁöÑAPIÂØÜÈí•
        },
        {
            id: 'deepseek-r1-distill-qwen-1.5b',
            name: 'DeepSeek R1 (ÈòøÈáå‰∫ëÁôæÁÇºÂÖçË¥π)',
            url: 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',
            apiKey: '' // ÊõøÊç¢‰∏∫ÊÇ®ÁöÑAPIÂØÜÈí•
        }
    ];

    // ÈªòËÆ§ËÆæÁΩÆ
    const DEFAULT_SETTINGS = {
        autoChatEnabled: true,
        selectedModelId: MODEL_CONFIGS[0].id,
        cooldownTime: 10000 // ËÅäÂ§©ÂõûÂ§çÂÜ∑Âç¥Êó∂Èó¥(ÊØ´Áßí)
    };

    // Áä∂ÊÄÅÂèòÈáè
    let settings = {...DEFAULT_SETTINGS};
    let cooldownActive = false;
    let lastChatContent = '';
    const USERNAME = 'deepseekËÅäÂ§©Êú∫Âô®‰∫∫'; // ÊõøÊç¢‰∏∫ÊÇ®ÁöÑËßíËâ≤Âêç

    // ------------Ê†∏ÂøÉÂäüËÉΩÂáΩÊï∞-----------

    // Ëé∑ÂèñÊúÄÂêé‰∏ÄÊù°ËÅäÂ§©Ê∂àÊÅØ
    function getLastChatMessage() {
        const chatLines = document.querySelectorAll('.chat-line');
        if (!chatLines.length) return null;

        const lastLine = chatLines[chatLines.length - 1];
        const nameElement = lastLine.querySelector('.chat-line-name-content');
        const messageElement = lastLine.querySelector('.chat-line-message');
        const labelElement = lastLine.querySelector('.chat-line-label');

        if (!nameElement || !messageElement) return null;

        // ËøáÊª§‰∏çÈúÄË¶ÅÂ§ÑÁêÜÁöÑÊ∂àÊÅØÁ±ªÂûã
        if (lastLine.classList.contains('chat-line-party')) return null;
        if (nameElement.textContent.trim() === USERNAME) return null;
        if (labelElement?.getAttribute('title') === 'Whisper') return null;
        if (messageElement.textContent.trim() === 'Rejoined' ||
            lastLine.classList.contains('chat-line-system')) return null;

        return {
            name: nameElement.textContent.trim(),
            message: messageElement.textContent.trim(),
            element: messageElement
        };
    }

    // Êü•ËØ¢AIÊ®°Âûã
    async function queryAI(message) {
        const modelConfig = MODEL_CONFIGS.find(m => m.id === settings.selectedModelId);
        if (!modelConfig) throw new Error('Êú™ÊâæÂà∞Ê®°ÂûãÈÖçÁΩÆ');

        return new Promise((resolve, reject) => {
            GM_xmlhttpRequest({
                method: 'POST',
                url: modelConfig.url,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${modelConfig.apiKey}`
                },
                data: JSON.stringify({
                    model: modelConfig.id,
                    messages: [{ role: 'user', content: message }],
                    stream: false
                }),
                onload: (response) => {
                    try {
                        const data = JSON.parse(response.responseText);
                        if (data.choices && data.choices.length > 0) {
                            resolve(data.choices[0].message.content.trim());
                        } else {
                            reject('APIËøîÂõûÁ©∫ÂìçÂ∫î');
                        }
                    } catch (e) {
                        reject('Ëß£ÊûêAPIÂìçÂ∫îÂ§±Ë¥•');
                    }
                },
                onerror: (error) => {
                    reject(`APIËØ∑Ê±ÇÈîôËØØ: ${error.status}`);
                }
            });
        });
    }

    // ÂèëÈÄÅËÅäÂ§©ÂõûÂ§ç
    function sendChatReply(message) {
        const chatInput = document.querySelector('.chat-textarea.chat-commons.hide-scrollbar');
        const sendButton = document.querySelector("#chat-box > div > div > div.chat-box-controls > ui-button > button");

        if (chatInput && sendButton) {
            chatInput.value = message;
            const event = new Event('input', { bubbles: true });
            chatInput.dispatchEvent(event);

            setTimeout(() => {
                sendButton.click();
                console.log('Â∑≤ÂèëÈÄÅËÅäÂ§©ÂõûÂ§ç:', message);
                cooldownActive = true;
                setTimeout(() => cooldownActive = false, settings.cooldownTime);
            }, 2000 + Math.random() * 3000);
        } else {
            console.log('ÂèëÈÄÅËÅäÂ§©ÂõûÂ§çÂ§±Ë¥•');
        }
    }

    // Â§ÑÁêÜËÅäÂ§©Ê∂àÊÅØ
    async function processChatMessages() {
        if (cooldownActive || !settings.autoChatEnabled) return;

        const chat = getLastChatMessage();
        if (!chat || chat.message === lastChatContent) return;

        try {
            console.log('Êî∂Âà∞Êñ∞Ê∂àÊÅØ:', `${chat.name}: ${chat.message}`);
            lastChatContent = chat.message;

            const response = await queryAI(
                `‰Ω†ÊòØ‰∏Ä‰∏™Âú®Pony TownÊ∏∏Êàè‰∏≠ÁöÑÂ∞èÈ©¨ËßíËâ≤ÔºåÂè´${USERNAME}„ÄÇËØ∑Áî®30‰∏™Â≠óÁ¨¶‰ª•ÂÜÖÁöÑÁÆÄÁü≠ÂèØÁà±ÁöÑÂõûÂ§çÔºö\n\n` +
                `[${chat.name}]: ${chat.message}`
            );

            if (response) {
                console.log('AIÂõûÂ§ç:', response);
                sendChatReply(response);
            }
        } catch (error) {
            console.error('Â§ÑÁêÜËÅäÂ§©Êó∂Âá∫Èîô:', error);
        }
    }

    //------------------ÊéßÂà∂Èù¢Êùø-------------------

    function createControlPanel() {
        const panel = document.createElement('div');
        panel.id = 'pt-control-panel';
        panel.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background: rgba(30, 30, 46, 0.85);
            border-radius: 12px;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            border: 1px solid #44475a;
            color: #f8f8f2;
            font-family: Arial, sans-serif;
            min-width: 280px;
        `;

        // Ê†áÈ¢ò
        const title = document.createElement('div');
        title.textContent = 'Pony Town Âä©Êâã';
        title.style.cssText = `
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #bd93f9;
            text-align: center;
        `;
        panel.appendChild(title);

        // ËÅäÂ§©ÂºÄÂÖ≥
        const chatToggle = createControlButton(
            settings.autoChatEnabled ? 'üü¢ ËÅäÂ§©ÂºÄÂêØ' : 'üî¥ ËÅäÂ§©ÂÖ≥Èó≠',
            () => toggleFeature('autoChatEnabled'),
            settings.autoChatEnabled ? '#50fa7b' : '#ff5555'
        );
        chatToggle.title = 'ÂºÄÂêØ/ÂÖ≥Èó≠Ëá™Âä®ËÅäÂ§©ÂäüËÉΩ';
        panel.appendChild(chatToggle);

        // Ê®°ÂûãÈÄâÊã©Âô®
        const modelSelector = document.createElement('select');
        modelSelector.id = 'model-selector';
        modelSelector.style.cssText = `
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #6272a4;
            background: #282a36;
            color: #f8f8f2;
            margin-top: 8px;
            cursor: pointer;
        `;

        MODEL_CONFIGS.forEach(model => {
            const option = document.createElement('option');
            option.value = model.id;
            option.textContent = model.name;
            option.selected = model.id === settings.selectedModelId;
            modelSelector.appendChild(option);
        });

        modelSelector.addEventListener('change', function() {
            settings.selectedModelId = this.value;
            GM_setValue('pt_settings', settings);
            console.log('Â∑≤ÂàáÊç¢Ê®°Âûã:', this.options[this.selectedIndex].text);
        });

        const modelLabel = document.createElement('div');
        modelLabel.textContent = 'AIÊ®°Âûã:';
        modelLabel.style.marginTop = '12px';
        modelLabel.style.marginBottom = '5px';
        modelLabel.style.fontSize = '14px';
        panel.appendChild(modelLabel);
        panel.appendChild(modelSelector);

        // ÂÜ∑Âç¥Êó∂Èó¥Ë∞ÉËäÇÂô®
        const cooldownLabel = document.createElement('div');
        cooldownLabel.textContent = `ÂÜ∑Âç¥Êó∂Èó¥: ${settings.cooldownTime/1000}Áßí`;
        cooldownLabel.style.marginTop = '12px';
        cooldownLabel.style.marginBottom = '5px';
        cooldownLabel.style.fontSize = '14px';
        panel.appendChild(cooldownLabel);

        const cooldownSlider = document.createElement('input');
        cooldownSlider.type = 'range';
        cooldownSlider.min = '3';
        cooldownSlider.max = '30';
        cooldownSlider.value = settings.cooldownTime/1000;
        cooldownSlider.style.width = '100%';
        cooldownSlider.style.cursor = 'pointer';

        cooldownSlider.addEventListener('input', function() {
            settings.cooldownTime = this.value * 1000;
            cooldownLabel.textContent = `ÂÜ∑Âç¥Êó∂Èó¥: ${this.value}Áßí`;
            GM_setValue('pt_settings', settings);
        });
        panel.appendChild(cooldownSlider);

        // Áä∂ÊÄÅÊåáÁ§∫Âô®
        const statusIndicator = document.createElement('div');
        statusIndicator.id = 'pt-status';
        statusIndicator.textContent = 'Áä∂ÊÄÅ: ËøêË°å‰∏≠';
        statusIndicator.style.marginTop = '15px';
        statusIndicator.style.paddingTop = '15px';
        statusIndicator.style.borderTop = '1px solid #6272a4';
        statusIndicator.style.fontSize = '13px';
        statusIndicator.style.color = '#8be9fd';
        panel.appendChild(statusIndicator);

        document.body.appendChild(panel);

        // Ê∑ªÂä†ÂèØÊãñÂä®ÂäüËÉΩ
        makeElementDraggable(panel);
    }

    function createControlButton(text, onClick, color = '#bd93f9') {
        const button = document.createElement('button');
        button.textContent = text;
        button.style.cssText = `
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            background: ${color};
            color: #282a36;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        `;

        button.addEventListener('click', function() {
            this.style.transform = 'scale(0.98)';
            setTimeout(() => { this.style.transform = 'scale(1)'; }, 200);
            onClick();
        });

        button.addEventListener('mouseenter', () => {
            button.style.filter = 'brightness(1.1)';
            button.style.boxShadow = '0 4px 10px rgba(0,0,0,0.3)';
        });

        button.addEventListener('mouseleave', () => {
            button.style.filter = 'none';
            button.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
        });

        return button;
    }

    function makeElementDraggable(element) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

        const header = document.createElement('div');
        header.textContent = '‚â°';
        header.style.cssText = `
            padding: 8px;
            cursor: move;
            text-align: center;
            background: rgba(40, 42, 54, 0.7);
            border-radius: 8px 8px 0 0;
            color: #f8f8f2;
            font-size: 18px;
            user-select: none;
        `;
        element.insertBefore(header, element.firstChild);

        header.addEventListener('mousedown', dragMouseDown);

        function dragMouseDown(e) {
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.addEventListener('mouseup', closeDragElement);
            document.addEventListener('mousemove', elementDrag);
        }

        function elementDrag(e) {
            e.preventDefault();
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            element.style.top = (element.offsetTop - pos2) + "px";
            element.style.right = "unset";
            element.style.left = (element.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
            document.removeEventListener('mouseup', closeDragElement);
            document.removeEventListener('mousemove', elementDrag);
        }
    }

    function toggleFeature(feature) {
        settings[feature] = !settings[feature];
        GM_setValue('pt_settings', settings);

        const statusElement = document.getElementById('pt-status');
        if (statusElement) {
            statusElement.textContent = `Áä∂ÊÄÅ: ${settings[feature] ? 'ËøêË°å‰∏≠' : 'Â∑≤ÊöÇÂÅú'}`;
        }

        // Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨
        if (feature === 'autoChatEnabled') {
            const button = document.querySelector('#pt-control-panel > button');
            if (button) {
                button.textContent = settings.autoChatEnabled ? 'üü¢ ËÅäÂ§©ÂºÄÂêØ' : 'üî¥ ËÅäÂ§©ÂÖ≥Èó≠';
                button.style.background = settings.autoChatEnabled ? '#50fa7b' : '#ff5555';
            }
        }

        console.log(`ÂäüËÉΩ ${feature} ${settings[feature] ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}`);
    }

    function initScript() {
        // Âä†ËΩΩ‰øùÂ≠òÁöÑËÆæÁΩÆ
        const savedSettings = GM_getValue('pt_settings');
        if (savedSettings) {
            settings = {...DEFAULT_SETTINGS, ...savedSettings};
        }

        // ÂàõÂª∫ÊéßÂà∂Èù¢Êùø
        createControlPanel();

        // Á°Æ‰øùÈù¢Êùø‰∏çË¢´Ê∏∏ÊàèË¶ÜÁõñ
        const style = document.createElement('style');
        style.textContent = `
            div[style*="z-index: 1300;"] ~ #pt-control-panel {
                z-index: 9999 !important;
            }
            .chat-box-controls {
                z-index: 9998 !important;
            }
        `;
        document.head.appendChild(style);
    }

    // ÂêØÂä®ËÑöÊú¨
    setTimeout(() => {
        initScript();
        setInterval(processChatMessages, 5000);
        console.log('Pony TownËá™Âä®ËÅäÂ§©ËÑöÊú¨Â∑≤ÂêØÂä®');
    }, 3000);
})();